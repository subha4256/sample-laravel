name: Deploy Laravel to EC2 using SSM

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Configure AWS credentials
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      run: |
        aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID
        aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY
        aws configure set default.region us-east-1

    - name: Deploy Laravel Application
      run: |
        aws ssm start-session \
          --target "i-028a32175b8ed30c2" \
          --document-name "AWS-StartSSHSession" \
          --parameters "portNumber=22" \
          --region us-east-1

    - name: Run Deployment Commands via SSM
      run: |
        aws ssm send-command \
          --instance-ids "i-028a32175b8ed30c2" \
          --document-name "AWS-RunShellScript" \
          --comment "Deploying Laravel application from GitHub" \
          --parameters commands="
            cd /var/www/html/testlaravel &&
            git pull origin main &&
            composer install --optimize-autoloader --no-dev &&
            php artisan migrate --force &&
            php artisan config:cache &&
            php artisan route:cache &&
            php artisan view:cache &&
            sudo systemctl restart apache2
          " \
          --output text
